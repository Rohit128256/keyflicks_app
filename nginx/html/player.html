<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your Premium Video Player</title>
  <link href="https://vjs.zencdn.net/7.20.3/video-js.min.css" rel="stylesheet">
  <!-- plugin CSS -->
  <link rel="stylesheet" href="https://unpkg.com/videojs-hls-quality-selector@1.1.4/dist/videojs-hls-quality-selector.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* (kept exactly as in your original — omitted here for brevity in explanation) */
    * { margin:0; padding:0; box-sizing:border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: linear-gradient(135deg, #0f1b40, #2a0a3a, #0f1b40); min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:40px 20px; color:white; }
    .container { max-width:1000px; width:100%; background:rgba(10,10,20,0.9); border-radius:20px; overflow:hidden; box-shadow:0 15px 30px rgba(0,0,0,0.7); backdrop-filter: blur(10px); border:1px solid rgba(100,100,200,0.2); }
    header { text-align:center; padding:25px 20px; background:rgba(0,0,0,0.5); border-bottom:1px solid rgba(100,100,200,0.3); }
    h1 { font-size:2.5rem; margin-bottom:10px; background: linear-gradient(to right, #4facfe, #00f2fe); -webkit-background-clip:text; -webkit-text-fill-color:transparent; text-shadow:0 2px 10px rgba(0,0,0,0.3); }
    .subtitle { font-size:1.1rem; color:#aaccff; max-width:600px; margin:0 auto; line-height:1.6; }
    .video-input-section { padding:25px; background: rgba(0,0,0,0.3); border-bottom:1px solid rgba(100,100,200,0.2); }
    #video-form { display:flex; gap:15px; justify-content:center; align-items:center; flex-wrap:wrap; }
    #video-id-input { flex-grow:1; max-width:400px; padding:12px 15px; border-radius:8px; border:1px solid rgba(100,150,255,0.3); background:rgba(0,10,30,0.8); color:white; font-size:1rem; }
    #video-form button { padding:12px 25px; border-radius:8px; border:none; background: linear-gradient(to right, #4facfe, #00f2fe); color:white; font-size:1rem; font-weight:bold; cursor:pointer; transition: transform 0.2s ease; }
    #video-form button:hover { transform: scale(1.05); }
    #status-message { text-align:center; padding:15px; margin:20px 25px 0; border-radius:8px; display:none; font-size:1.1rem; }
    .status-info { background: rgba(79,172,254,0.2); border: 1px solid rgba(79,172,254,0.4); color:#4facfe; }
    .status-warning { background: rgba(255,165,0,0.2); border:1px solid rgba(255,165,0,0.4); color:orange; }
    .status-error { background: rgba(255,0,0,0.2); border:1px solid rgba(255,0,0,0.4); color:#ff8a8a; }
    .player-content-wrapper { display:none; }
    .player-container { padding:20px; background:#000; position:relative; }
    .video-wrapper { position:relative; overflow:hidden; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,0.8); }
    .video-js { width:100%; height:0; padding-top:56.25%; border-radius:10px; }
    .info-section { display:flex; justify-content:space-between; padding:20px; background: rgba(20,30,60,0.7); margin:20px; border-radius:10px; border:1px solid rgba(100,150,255,0.2); }
    .info-card { flex:1; padding:15px; background: rgba(0,10,30,0.6); border-radius:10px; margin:0 10px; text-align:center; }
    .info-card h3 { color:#4facfe; margin-bottom:10px; font-size:1.2rem; }
    .info-card p { color:#cce5ff; font-size:1rem; }
    .tech-badges { display:flex; justify-content:center; flex-wrap:wrap; gap:10px; margin-top:15px; }
    .badge { background: rgba(79,172,254,0.2); color:#4facfe; padding:5px 10px; border-radius:20px; font-size:0.85rem; border:1px solid rgba(79,172,254,0.3); }
    .features { display:grid; grid-template-columns: repeat(auto-fit, minmax(250px,1fr)); gap:20px; padding:0 20px 30px; }
    .feature-card { background: rgba(20,30,60,0.6); padding:20px; border-radius:10px; text-align:center; border:1px solid rgba(100,150,255,0.2); transition: transform .3s ease, background .3s ease; }
    .feature-card:hover { transform: translateY(-5px); background: rgba(30,50,100,0.8); box-shadow:0 5px 15px rgba(0,0,0,0.3); }
    .feature-card i { font-size:2.5rem; color:#4facfe; margin-bottom:15px; text-shadow:0 0 10px rgba(79,172,254,0.5); }
    .feature-card h3 { margin-bottom:10px; color:#4facfe; }
    .feature-card p { color:#cce5ff; line-height:1.6; }
    footer { text-align:center; padding:20px; color:#88aaff; font-size:0.9rem; border-top:1px solid rgba(100,150,255,0.2); }
    @media (max-width:768px) { .info-section { flex-direction:column } .info-card { margin:10px 0 } h1 { font-size:2rem } }
    .video-js .vjs-control-bar { background: rgba(0,10,30,0.8) !important; backdrop-filter: blur(5px); }
    .video-js .vjs-big-play-button { background: rgba(79,172,254,0.7) !important; border:none !important; width:80px !important; height:80px !important; border-radius:50% !important; line-height:80px !important; top:50% !important; left:50% !important; transform: translate(-50%,-50%); font-size:3em; text-shadow:0 0 10px rgba(0,0,0,0.5); }
    .video-js .vjs-playback-rate .vjs-menu-button-popup .vjs-menu .vjs-menu-content { background: rgba(0,10,30,0.9) !important; border-radius:8px; border:1px solid rgba(100,150,255,0.3); }
    .video-js .vjs-menu-button-popup .vjs-menu { bottom:3em; }
    .video-js .vjs-icon-placeholder:before { color:#4facfe; text-shadow:0 0 5px rgba(79,172,254,0.5); }
    .error-message { display:none; position:absolute; top:50%; left:50%; transform: translate(-50%,-50%); background: rgba(200,50,50,0.8); padding:20px; border-radius:10px; text-align:center; z-index:10; max-width:80%; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Your Premium Video Stream</h1>
      <p class="subtitle">Enter a Video ID to load your HLS stream with full playback controls.</p>
    </header>

    <div class="video-input-section">
      <form id="video-form">
        <input type="text" id="video-id-input" placeholder="Enter Video ID here..." required>
        <button type="submit">Load Video</button>
      </form>
      <div id="status-message"></div>
    </div>

    <div class="player-content-wrapper" id="player-content-wrapper">
      <div class="player-container">
        <div class="error-message" id="player-error-message">
          <h3><i class="fas fa-exclamation-triangle"></i> Stream Error</h3>
          <p id="error-text">Failed to load video stream</p>
        </div>

        <div class="video-wrapper">
          <video id="my-video" class="video-js vjs-big-play-centered" controls preload="auto"
                 poster="https://images.unsplash.com/photo-1574717024453-354056aafa98?auto=format&fit=crop&w=1200&q=80"
                 data-setup='{}'>
            <p class="vjs-no-js">
              To view this video please enable JavaScript, and consider upgrading to a web browser that
              <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
            </p>
          </video>
        </div>
      </div>

      <div class="info-section">
        <div class="info-card">
          <h3>Stream Information</h3>
          <p>Your Uploaded Content</p>
          <p>Adaptive HLS Streaming</p>
          <div class="tech-badges">
            <span class="badge">HLS</span>
            <span class="badge">Adaptive</span>
            <span class="badge">Your Content</span>
          </div>
        </div>

        <div class="info-card">
          <h3>Player Features</h3>
          <p>Quality Selection</p>
          <p>Playback Speed Control</p>
          <div class="tech-badges">
            <span class="badge">Video.js</span>
            <span class="badge">HD Ready</span>
          </div>
        </div>
      </div>

      <div class="features">
        <div class="feature-card"><i class="fas fa-sliders-h"></i><h3>Quality Selection</h3><p>Manually choose between different resolutions for optimal viewing.</p></div>
        <div class="feature-card"><i class="fas fa-tachometer-alt"></i><h3>Playback Speed</h3><p>Adjust video speed from 0.5x to 2.0x to watch at your pace.</p></div>
        <div class="feature-card"><i class="fas fa-broadcast-tower"></i><h3>Adaptive Streaming</h3><p>Automatic quality adjustment for smooth playback.</p></div>
        <div class="feature-card"><i class="fas fa-expand-arrows-alt"></i><h3>Fullscreen Mode</h3><p>Immersive viewing experience with high-definition fullscreen.</p></div>
      </div>

      <footer>
        <p>Your Premium Streaming Service | Powered by Video.js</p>
      </footer>
    </div>
  </div>

  <!-- script order: vjs -> quality-levels -> plugin -->
  <script src="https://vjs.zencdn.net/7.20.3/video.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-contrib-quality-levels@2.1.0/dist/videojs-contrib-quality-levels.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-hls-quality-selector@1.1.4/dist/videojs-hls-quality-selector.min.js"></script>
  
  <script>
    const videoForm = document.getElementById('video-form');
    const videoIdInput = document.getElementById('video-id-input');
    const statusMessage = document.getElementById('status-message');
    const playerContentWrapper = document.getElementById('player-content-wrapper');
    const playerErrorMessage = document.getElementById('player-error-message');
    const errorText = document.getElementById('error-text');
  
    // init player WITHOUT qualitySelector control — we'll init plugin after source loads
    const player = videojs('my-video', {
      controlBar: {
        children: [
          'playToggle','volumePanel','currentTimeDisplay','timeDivider',
          'durationDisplay','progressControl','remainingTimeDisplay',
          'customControlSpacer','playbackRateMenuButton','fullscreenToggle'
        ]
      }
    });
  
    player.ready(function() {
      console.log('Player ready');
      player.playbackRates([0.5,0.75,1,1.25,1.5,1.75,2]);
    });
  
    function showStatus(message, type='info'){
      statusMessage.textContent = message;
      statusMessage.className = `status-${type}`;
      statusMessage.style.display = 'block';
    }
  
    // helper: init plugin once with guard
    function initHlsQualitySelectorWithGuard() {
      if (player._hlsQualitySelectorInit) return;
      try {
        player.hlsQualitySelector({
          displayCurrentQuality: true,
          placementIndex: 8
        });
        player._hlsQualitySelectorInit = true;
        console.log('hlsQualitySelector initialized (guarded)');
      } catch (e) {
        console.warn('hlsQualitySelector init failed', e);
      }
    }
  
    // helper: inspect qualityLevels and log (for debugging)
    function logQualityLevels() {
      const ql = player.qualityLevels && player.qualityLevels();
      if (!ql) { console.log('No qualityLevels() API'); return null; }
      console.log('qualityLevels length =', ql.length);
      const info = [];
      for (let i = 0; i < ql.length; i++) {
        const lvl = ql[i];
        const obj = {
          index: i,
          height: lvl.height,
          width: lvl.width,
          bitrate: lvl.bitrate || lvl.bandwidth,
          id: lvl.id,
          enabled: lvl.enabled
        };
        console.log(i, obj);
        info.push(obj);
      }
      return info;
    }
  
    // fallback UI if plugin menu empty or heights missing
    function addQualityFallbackIfNeeded() {
      const ql = player.qualityLevels && player.qualityLevels();
      if (!ql || ql.length <= 1) return; // nothing to choose
      // If plugin created real menu items, don't add fallback
      const pluginMenuItems = document.querySelectorAll('.vjs-hls-quality-selector .vjs-menu-content li');
      if (pluginMenuItems && pluginMenuItems.length > 0) {
        console.log('plugin created menu items — no fallback needed');
        return;
      }
  
      // Avoid adding multiple fallbacks
      if (document.getElementById('quality-fallback-select')) return;
  
      const sel = document.createElement('select');
      sel.id = 'quality-fallback-select';
      sel.title = 'Quality';
      sel.style.padding = '6px';
      sel.style.borderRadius = '6px';
      sel.style.fontSize = '12px';
      sel.style.background = 'rgba(0,0,0,0.6)';
      sel.style.color = 'white';
      sel.style.border = '1px solid rgba(79,172,254,0.2)';
  
      const autoOpt = document.createElement('option');
      autoOpt.value = 'auto';
      autoOpt.text = 'Auto';
      sel.appendChild(autoOpt);
  
      for (let i = 0; i < ql.length; i++) {
        const h = ql[i].height || Math.round((ql[i].bitrate||ql[i].bandwidth||0)/1000) + 'kbps';
        const o = document.createElement('option');
        o.value = String(i);
        o.text = (ql[i].height ? `${ql[i].height}p` : h);
        sel.appendChild(o);
      }
  
      sel.addEventListener('change', function() {
        const v = sel.value;
        if (v === 'auto') {
          for (let j = 0; j < ql.length; j++) ql[j].enabled = true;
          console.log('Quality: auto (all enabled)');
        } else {
          for (let j = 0; j < ql.length; j++) ql[j].enabled = (j === Number(v));
          console.log('Quality: forced to level', v);
        }
      });
  
      // position the selector above control bar (non-intrusive)
      const container = document.createElement('div');
      container.style.position = 'absolute';
      container.style.right = '12px';
      container.style.bottom = '56px';
      container.style.zIndex = '999';
      container.appendChild(sel);
      player.el().appendChild(container);
      console.log('Added quality fallback select because plugin menu was empty or heights missing.');
    }
  
    // wait for qualityLevels to populate (poll, up to timeout), then init plugin
    function waitAndInitQualitySelector(timeoutMs = 2000, intervalMs = 100) {
      let elapsed = 0;
      const t = setInterval(() => {
        const ql = player.qualityLevels && player.qualityLevels();
        if (ql && ql.length > 0) {
          console.log('qualityLevels detected, initializing plugin');
          clearInterval(t);
          logQualityLevels();
          initHlsQualitySelectorWithGuard();
          // small timeout to let plugin build menu before we check for fallback
          setTimeout(addQualityFallbackIfNeeded, 200);
          return;
        }
        elapsed += intervalMs;
        if (elapsed >= timeoutMs) {
          clearInterval(t);
          console.warn('Timed out waiting for qualityLevels. Will still attempt plugin init and fallback.');
          logQualityLevels();
          initHlsQualitySelectorWithGuard();
          setTimeout(addQualityFallbackIfNeeded, 300);
        }
      }, intervalMs);
    }
  
    // --- New: playlist blob handling + auto-refresh logic ---
    let currentPlaylistBlobUrl = null;
    let refreshTimerId = null;
  
    function revokeCurrentBlob() {
      try {
        if (currentPlaylistBlobUrl) {
          URL.revokeObjectURL(currentPlaylistBlobUrl);
        }
      } catch (e) { /* ignore */ }
      currentPlaylistBlobUrl = null;
    }
  
    function schedulePlaylistRefresh(minExpiryTs) {
      // clear previous timer
      if (refreshTimerId) {
        clearTimeout(refreshTimerId);
        refreshTimerId = null;
      }
      const now = Math.floor(Date.now() / 1000);
      // refresh 60s before expiry, at minimum 10s from now
      let refreshAt = (minExpiryTs - 60);
      if (refreshAt <= now + 10) refreshAt = now + 10;
      const delayMs = (refreshAt - now) * 1000;
      console.log('scheduling playlist refresh in', Math.round(delayMs/1000), 'seconds (refreshAt ts =', refreshAt, ')');
      refreshTimerId = setTimeout(async () => {
        try {
          console.log('Refreshing playlist before expiry...');
          await fetchAndApplyMasterPlaylist(currentVideoId, true);
        } catch (e) {
          console.warn('Playlist refresh failed', e);
        }
      }, delayMs);
    }
  
    // Parse variant lines from master playlist and return smallest st (expiry) found (unix ts)
    function findMinExpiryFromMaster(masterText) {
      const lines = masterText.split(/\r?\n/);
      let min = Infinity;
      const sigRe = /[?&]st=(\d+)/;
      for (const line of lines) {
        if (!line || line.startsWith('#')) continue;
        // look for st param in URL
        const m = line.match(sigRe);
        if (m && m[1]) {
          const t = parseInt(m[1], 10);
          if (!isNaN(t) && t < min) min = t;
        }
      }
      return (min === Infinity ? null : min);
    }
  
    // fetch master playlist from /api/playlist/<videoId>, create blob url and set player src
    let currentVideoId = null;
    async function fetchAndApplyMasterPlaylist(videoId, isRefresh=false) {
      const playlistUrl = `/api/master/${encodeURIComponent(videoId)}`;
      // request no-cache to avoid stale playlists
      // const res = await fetch(playlistUrl, { cache: "no-store" });
      // if (!res.ok) throw new Error(`Failed to fetch playlist: ${res.status}`);
      // const playlistText = await res.text();
  
      // OPTIONAL sanity: ensure playlist contains absolute variant URLs (starting with / or http)
      // If variant entries are relative (rare in our flow), we might need different handling.
      // We'll assume FastAPI produced absolute variant URLs (e.g., /api/playlist/... or /videos/...)
      // Build blob so player can parse master content directly
      // const blob = new Blob([playlistText], { type: "application/vnd.apple.mpegurl" });
      // const blobUrl = URL.createObjectURL(blob);
  
      // // apply to video.js player
      // revokeCurrentBlob();
      currentPlaylistBlobUrl = blobUrl;
      player.src({ src: playlistUrl, type: 'application/x-mpegURL' });
  
      // attempt autoplay if requested
      if (!isRefresh) {
        player.play().catch(e => console.warn('Autoplay prevented', e));
      }
  
      // init quality selector flow after giving VHS a moment to parse manifest
      waitAndInitQualitySelector(2000, 100);
  
      // schedule refresh before expiry if st found in master
      const minExpiry = findMinExpiryFromMaster(playlistText);
      if (minExpiry) {
        schedulePlaylistRefresh(minExpiry);
      } else {
        // no st found: don't schedule refresh
        if (refreshTimerId) { clearTimeout(refreshTimerId); refreshTimerId = null; }
      }
    }
  
    // form submit handler
    videoForm.addEventListener('submit', async function (event) {
      event.preventDefault();
      const videoId = videoIdInput.value.trim();
      if (!videoId) { showStatus('Please enter a Video ID.', 'error'); return; }
  
      playerContentWrapper.style.display = 'none';
      player.pause();
      showStatus(`🔍 Validating Video ID: ${videoId}...`, 'info');
  
      try {
        const response = await fetch(`http://localhost:80/api/status/${encodeURIComponent(videoId)}`);
        if (response.status === 404) throw new Error('Video not found. Please check the ID and try again.');
        if (!response.ok) throw new Error(`Server returned an error: ${response.statusText}`);
        const data = await response.json();
  
        if (data.status === 'ready') {
          statusMessage.style.display = 'none';
          playerContentWrapper.style.display = 'block';
          currentVideoId = videoId;
  
          // Fetch signed master playlist, apply as blob, schedule refresh automatically
          await fetchAndApplyMasterPlaylist(videoId);
  
          // WAIT for qualityLevels to be available and then init the plugin
          waitAndInitQualitySelector(2000, 100);
  
        } else if (data.status === 'processing') {
          showStatus('⏳ This video is still processing. Please wait a few moments and try again.', 'warning');
        } else {
          throw new Error(`Unknown video status: "${data.status}"`);
        }
      } catch (err) {
        console.error('Failed to load video:', err);
        showStatus(`Error: ${err.message}`, 'error');
        playerContentWrapper.style.display = 'none';
      }
    });
  
    // player error handling
    player.on('error', function() {
      const error = player.error();
      console.error('Player error:', error);
      errorText.textContent = `Error: ${error ? error.message : 'Failed to load video stream'}`;
      playerErrorMessage.style.display = 'block';
    });
  
    player.on('loadstart', function() {
      playerErrorMessage.style.display = 'none';
    });
  
  </script>    
</body>
</html>
