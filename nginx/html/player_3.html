<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Secret Video Streaming platform</title>
  <link href="https://vjs.zencdn.net/7.20.3/video-js.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/videojs-hls-quality-selector@1.1.4/dist/videojs-hls-quality-selector.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: linear-gradient(135deg, #0f1b40, #2a0a3a, #0f1b40); min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:40px 20px; color:white; }
    .container { max-width:1000px; width:100%; background:rgba(10,10,20,0.9); border-radius:20px; overflow:hidden; box-shadow:0 15px 30px rgba(0,0,0,0.7); backdrop-filter: blur(10px); border:1px solid rgba(100,100,200,0.2); }
    header { text-align:center; padding:25px 20px; background:rgba(0,0,0,0.5); border-bottom:1px solid rgba(100,100,200,0.3); }
    h1 { font-size:2.5rem; margin-bottom:10px; background: linear-gradient(to right, #4facfe, #00f2fe); -webkit-background-clip:text; -webkit-text-fill-color:transparent; text-shadow:0 2px 10px rgba(0,0,0,0.3); }
    .subtitle { font-size:1.1rem; color:#aaccff; max-width:600px; margin:0 auto; line-height:1.6; }
    .video-input-section { padding:25px; background: rgba(0,0,0,0.3); border-bottom:1px solid rgba(100,100,200,0.2); }
    #video-form { display:flex; gap:15px; justify-content:center; align-items:center; flex-wrap:wrap; }
    #video-id-input { flex-grow:1; max-width:400px; padding:12px 15px; border-radius:8px; border:1px solid rgba(100,150,255,0.3); background:rgba(0,10,30,0.8); color:white; font-size:1rem; }
    #video-form button { padding:12px 25px; border-radius:8px; border:none; background: linear-gradient(to right, #4facfe, #00f2fe); color:white; font-size:1rem; font-weight:bold; cursor:pointer; transition: transform 0.2s ease; }
    #video-form button:hover { transform: scale(1.05); }
    #status-message { word-break: break-all; text-align:center; padding:15px; margin:20px 25px 0; border-radius:8px; display:none; font-size:1.1rem; }
    .status-info { word-break: break-all; background: rgba(79,172,254,0.2); border: 1px solid rgba(79,172,254,0.4); color:#4facfe; }
    .status-warning { word-break: break-all; background: rgba(255,165,0,0.2); border:1px solid rgba(255,165,0,0.4); color:orange; }
    .status-error { word-break: break-all; background: rgba(255,0,0,0.2); border:1px solid rgba(255,0,0,0.4); color:#ff8a8a; }
    .player-content-wrapper { display:none; }
    .player-container { padding:20px; background:#000; position:relative; }
    .video-wrapper { position:relative; overflow:hidden; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,0.8); }
    .video-js { width:100%; height:0; padding-top:56.25%; border-radius:10px; }
    .info-section { display:flex; justify-content:space-between; padding:20px; background: rgba(20,30,60,0.7); margin:20px; border-radius:10px; border:1px solid rgba(100,150,255,0.2); }
    .info-card { flex:1; padding:15px; background: rgba(0,10,30,0.6); border-radius:10px; margin:0 10px; text-align:center; }
    .info-card h3 { color:#4facfe; margin-bottom:10px; font-size:1.2rem; }
    .info-card p { color:#cce5ff; font-size:1rem; }
    .tech-badges { display:flex; justify-content:center; flex-wrap:wrap; gap:10px; margin-top:15px; }
    .badge { background: rgba(79,172,254,0.2); color:#4facfe; padding:5px 10px; border-radius:20px; font-size:0.85rem; border:1px solid rgba(79,172,254,0.3); }
    .features { display:grid; grid-template-columns: repeat(auto-fit, minmax(250px,1fr)); gap:20px; padding:0 20px 30px; }
    .feature-card { background: rgba(20,30,60,0.6); padding:20px; border-radius:10px; text-align:center; border:1px solid rgba(100,150,255,0.2); transition: transform .3s ease, background .3s ease; }
    .feature-card:hover { transform: translateY(-5px); background: rgba(30,50,100,0.8); box-shadow:0 5px 15px rgba(0,0,0,0.3); }
    .feature-card i { font-size:2.5rem; color:#4facfe; margin-bottom:15px; text-shadow:0 0 10px rgba(79,172,254,0.5); }
    .feature-card h3 { margin-bottom:10px; color:#4facfe; }
    .feature-card p { color:#cce5ff; line-height:1.6; }
    footer { text-align:center; padding:20px; color:#88aaff; font-size:0.9rem; border-top:1px solid rgba(100,150,255,0.2); }
    @media (max-width:768px) { .info-section { flex-direction:column } .info-card { margin:10px 0 } h1 { font-size:2rem } }
    .video-js .vjs-control-bar { background: rgba(0,10,30,0.8) !important; backdrop-filter: blur(5px); }
    .video-js .vjs-big-play-button { background: rgba(79,172,254,0.7) !important; border:none !important; width:80px !important; height:80px !important; border-radius:50% !important; line-height:80px !important; top:50% !important; left:50% !important; transform: translate(-50%,-50%); font-size:3em; text-shadow:0 0 10px rgba(0,0,0,0.5); }
    .video-js .vjs-playback-rate .vjs-menu-button-popup .vjs-menu .vjs-menu-content { background: rgba(0,10,30,0.9) !important; border-radius:8px; border:1px solid rgba(100,150,255,0.3); }
    .video-js .vjs-menu-button-popup .vjs-menu { bottom:3em; }
    .video-js .vjs-icon-placeholder:before { color:#4facfe; text-shadow:0 0 5px rgba(79,172,254,0.5); }
    .error-message { display:none; position:absolute; top:50%; left:50%; transform: translate(-50%,-50%); background: rgba(200,50,50,0.8); padding:20px; border-radius:10px; text-align:center; z-index:10; max-width:80%; }
    
    /* New CSS for upload functionality */
    .mode-tabs { display: flex; justify-content: center; margin-bottom: 20px; }
    .mode-tab { padding: 12px 24px; background: rgba(20,30,60,0.6); color: #cce5ff; border: none; cursor: pointer; font-size: 1rem; transition: all 0.3s ease; }
    .mode-tab:first-child { border-radius: 8px 0 0 8px; }
    .mode-tab:last-child { border-radius: 0 8px 8px 0; }
    .mode-tab.active { background: linear-gradient(to right, #4facfe, #00f2fe); color: white; }
    .upload-section { display: none; padding: 25px; background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(100,100,200,0.2); }
    .upload-form { display: flex; flex-direction: column; gap: 15px; max-width: 500px; margin: 0 auto; }
    .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; cursor: pointer; }
    .file-input-wrapper input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; height: 100%; width: 100%; }
    .file-input-button { padding: 12px 20px; background: linear-gradient(to right, #4facfe, #00f2fe); color: white; border-radius: 8px; text-align: center; cursor: pointer; }
    .file-name { margin-top: 5px; font-size: 0.9rem; color: #aaccff; }
    .upload-button { padding: 12px 25px; border-radius: 8px; border: none; background: linear-gradient(to right, #4facfe, #00f2fe); color: white; font-size: 1rem; font-weight: bold; cursor: pointer; transition: transform 0.2s ease; margin-top: 10px; }
    .upload-button:hover { transform: scale(1.05); }
    .upload-button:disabled { background: #555; cursor: not-allowed; transform: none; }
    .progress-bar { width: 100%; background: rgba(0,10,30,0.8); border-radius: 5px; overflow: hidden; margin-top: 15px; height: 20px; }
    .progress { height: 100%; background: linear-gradient(to right, #4facfe, #00f2fe); width: 0%; transition: width 0.3s ease; }
    .sse-status { margin-top: 20px; padding: 15px; border-radius: 8px; background: rgba(79,172,254,0.2); border: 1px solid rgba(79,172,254,0.4); }
    .success-message { margin-top: 20px; padding: 15px; border-radius: 8px; background: rgba(46,204,113,0.2); border: 1px solid rgba(46,204,113,0.4); color: #2ecc71; }
    
    /* Fix for long video IDs on mobile */
    .video-id-display {
      word-break: break-all;
      font-size: 0.9rem;
      line-height: 1.4;
      padding: 5px;
      background: rgba(0,0,0,0.2);
      border-radius: 4px;
      margin: 5px 0;
    }
    
    /* Quality selector fix styles */
    .vjs-hls-quality-selector .vjs-menu-button-popup .vjs-menu .vjs-menu-content {
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Secret Video Streaming Platform</h1>
      <p class="subtitle">Watch secret videos using secret id or upload new content with our premium streaming service.</p>
    </header>

    <div class="mode-tabs">
      <button class="mode-tab active" id="watch-tab">Watch Video</button>
      <button class="mode-tab" id="upload-tab">Upload Video</button>
    </div>

    <div class="video-input-section" id="watch-section">
      <form id="video-form">
        <input type="text" id="video-id-input" placeholder="Enter Video ID here..." required>
        <button type="submit">Load Video</button>
      </form>
      <div id="status-message"></div>
    </div>

    <div class="upload-section" id="upload-section">
      <form class="upload-form" id="upload-form">
        <div class="file-input-wrapper">
          <div class="file-input-button">
            <i class="fas fa-cloud-upload-alt"></i> Select Video File
          </div>
          <input type="file" id="video-file" accept="video/*" required>
          <div class="file-name" id="file-name">No file selected</div>
        </div>
        
        <button type="submit" class="upload-button" id="upload-button" disabled>
          <i class="fas fa-upload"></i> Upload Video
        </button>
      </form>
      
      <div class="progress-bar" id="progress-bar" style="display: none;">
        <div class="progress" id="progress"></div>
      </div>
      
      <div id="upload-status"></div>
      <div id="sse-status" style="display: none;"></div>
      <div id="success-message" class="success-message" style="display: none;"></div>
    </div>

    <div class="player-content-wrapper" id="player-content-wrapper">
      <div class="player-container">
        <div class="error-message" id="player-error-message">
          <h3><i class="fas fa-exclamation-triangle"></i> Stream Error</h3>
          <p id="error-text">Failed to load video stream</p>
        </div>

        <div class="video-wrapper">
          <video id="my-video" class="video-js vjs-big-play-centered" controls preload="auto"
                 poster="https://images.unsplash.com/photo-1574717024453-354056aafa98?auto=format&fit=crop&w=1200&q=80"
                 data-setup='{}'>
            <p class="vjs-no-js">
              To view this video please enable JavaScript, and consider upgrading to a web browser that
              <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
            </p>
          </video>
        </div>
      </div>

      <div class="info-section">
        <div class="info-card">
          <h3>Stream Information</h3>
          <p>Your Uploaded Content</p>
          <p>Adaptive HLS Streaming</p>
          <div class="tech-badges">
            <span class="badge">HLS</span>
            <span class="badge">Adaptive</span>
            <span class="badge">Your Content</span>
          </div>
        </div>

        <div class="info-card">
          <h3>Player Features</h3>
          <p>Quality Selection</p>
          <p>Playback Speed Control</p>
          <div class="tech-badges">
            <span class="badge">Video.js</span>
            <span class="badge">HD Ready</span>
          </div>
        </div>
      </div>

      <div class="features">
        <div class="feature-card"><i class="fas fa-sliders-h"></i><h3>Quality Selection</h3><p>Manually choose between different resolutions for optimal viewing.</p></div>
        <div class="feature-card"><i class="fas fa-tachometer-alt"></i><h3>Playback Speed</h3><p>Adjust video speed from 0.5x to 2.0x to watch at your pace.</p></div>
        <div class="feature-card"><i class="fas fa-broadcast-tower"></i><h3>Adaptive Streaming</h3><p>Automatic quality adjustment for smooth playback.</p></div>
        <div class="feature-card"><i class="fas fa-expand-arrows-alt"></i><h3>Fullscreen Mode</h3><p>Immersive viewing experience with high-definition fullscreen.</p></div>
      </div>

      <footer>
        <p>Your Premium Streaming Service | Powered by Video.js</p>
      </footer>
    </div>
  </div>

  <script src="https://vjs.zencdn.net/7.20.3/video.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-contrib-quality-levels@2.1.0/dist/videojs-contrib-quality-levels.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-hls-quality-selector@1.1.4/dist/videojs-hls-quality-selector.min.js"></script>
  
  <script>
    // Tab switching functionality
    const watchTab = document.getElementById('watch-tab');
    const uploadTab = document.getElementById('upload-tab');
    const watchSection = document.getElementById('watch-section');
    const uploadSection = document.getElementById('upload-section');

    watchTab.addEventListener('click', () => {
      watchTab.classList.add('active');
      uploadTab.classList.remove('active');
      watchSection.style.display = 'block';
      uploadSection.style.display = 'none';
    });

    uploadTab.addEventListener('click', () => {
      uploadTab.classList.add('active');
      watchTab.classList.remove('active');
      uploadSection.style.display = 'block';
      watchSection.style.display = 'none';
    });

    // Original player code
    const videoForm = document.getElementById('video-form');
    const videoIdInput = document.getElementById('video-id-input');
    const statusMessage = document.getElementById('status-message');
    const playerContentWrapper = document.getElementById('player-content-wrapper');
    const playerErrorMessage = document.getElementById('player-error-message');
    const errorText = document.getElementById('error-text');
    
    // Track current video ID for refreshing
    let currentVideoId = null;
    let sourceRefreshInterval = null;
  
    // Initialize player with specific options
    const player = videojs('my-video', {
      controlBar: {
        children: [
          'playToggle','volumePanel','currentTimeDisplay','timeDivider',
          'durationDisplay','progressControl','remainingTimeDisplay',
          'customControlSpacer','playbackRateMenuButton','fullscreenToggle'
        ]
      },
      html5: {
        vjs: {
          hls: {
            // Enable HLS quality selector
            enableLowInitialPlaylist: true,
            smoothQualityChange: true,
            useNetworkInformationApi: true
          }
        }
      }
    });
  
    player.ready(function() {
      console.log('Player ready');
      player.playbackRates([0.5,0.75,1,1.25,1.5,1.75,2]);
    });
  
    function showStatus(message, type='info'){
      statusMessage.textContent = message;
      statusMessage.className = `status-${type}`;
      statusMessage.style.display = 'block';
    }
  
    // Initialize quality selector plugin with guard
    function initHlsQualitySelectorWithGuard() {
      if (player._hlsQualitySelectorInit) return;
      try {
        player.hlsQualitySelector({
          displayCurrentQuality: true,
          placementIndex: 8,
          vjsIconClass: 'vjs-icon-hd'
        });
        player._hlsQualitySelectorInit = true;
        console.log('hlsQualitySelector initialized (guarded)');
      } catch (e) {
        console.warn('hlsQualitySelector init failed', e);
      }
    }
  
    // Log quality levels for debugging
    function logQualityLevels() {
      const ql = player.qualityLevels && player.qualityLevels();
      if (!ql) { console.log('No qualityLevels() API'); return null; }
      console.log('qualityLevels length =', ql.length);
      const info = [];
      for (let i = 0; i < ql.length; i++) {
        const lvl = ql[i];
        const obj = {
          index: i,
          height: lvl.height,
          width: lvl.width,
          bitrate: lvl.bitrate || lvl.bandwidth,
          id: lvl.id,
          enabled: lvl.enabled
        };
        console.log(i, obj);
        info.push(obj);
      }
      return info;
    }
  
    // Add fallback UI if plugin menu is empty
    function addQualityFallbackIfNeeded() {
      const ql = player.qualityLevels && player.qualityLevels();
      if (!ql || ql.length <= 1) return; // nothing to choose
      
      // If plugin created real menu items, don't add fallback
      const pluginMenuItems = document.querySelectorAll('.vjs-hls-quality-selector .vjs-menu-content li');
      if (pluginMenuItems && pluginMenuItems.length > 0) {
        console.log('plugin created menu items â€” no fallback needed');
        return;
      }
  
      // Avoid adding multiple fallbacks
      if (document.getElementById('quality-fallback-select')) return;
  
      const sel = document.createElement('select');
      sel.id = 'quality-fallback-select';
      sel.title = 'Quality';
      sel.style.padding = '6px';
      sel.style.borderRadius = '6px';
      sel.style.fontSize = '12px';
      sel.style.background = 'rgba(0,0,0,0.6)';
      sel.style.color = 'white';
      sel.style.border = '1px solid rgba(79,172,254,0.2)';
  
      const autoOpt = document.createElement('option');
      autoOpt.value = 'auto';
      autoOpt.text = 'Auto';
      sel.appendChild(autoOpt);
  
      for (let i = 0; i < ql.length; i++) {
        const h = ql[i].height || Math.round((ql[i].bitrate||ql[i].bandwidth||0)/1000) + 'kbps';
        const o = document.createElement('option');
        o.value = String(i);
        o.text = (ql[i].height ? `${ql[i].height}p` : h);
        sel.appendChild(o);
      }
  
      sel.addEventListener('change', function() {
        const v = sel.value;
        if (v === 'auto') {
          for (let j = 0; j < ql.length; j++) ql[j].enabled = true;
          console.log('Quality: auto (all enabled)');
        } else {
          for (let j = 0; j < ql.length; j++) ql[j].enabled = (j === Number(v));
          console.log('Quality: forced to level', v);
        }
      });
  
      // Position the selector above control bar
      const container = document.createElement('div');
      container.style.position = 'absolute';
      container.style.right = '12px';
      container.style.bottom = '56px';
      container.style.zIndex = '999';
      container.appendChild(sel);
      player.el().appendChild(container);
      console.log('Added quality fallback select because plugin menu was empty or heights missing.');
    }
  
    // Wait for qualityLevels to populate, then init plugin
    function waitAndInitQualitySelector(timeoutMs = 5000, intervalMs = 100) {
      let elapsed = 0;
      const t = setInterval(() => {
        const ql = player.qualityLevels && player.qualityLevels();
        if (ql && ql.length > 0) {
          console.log('qualityLevels detected, initializing plugin');
          clearInterval(t);
          logQualityLevels();
          initHlsQualitySelectorWithGuard();
          
          // Additional check after a delay to ensure menu is built
          setTimeout(() => {
            const menuItems = document.querySelectorAll('.vjs-hls-quality-selector .vjs-menu-content li');
            if (menuItems.length === 0) {
              console.log('No menu items found, adding fallback');
              addQualityFallbackIfNeeded();
            }
          }, 500);
          
          return;
        }
        elapsed += intervalMs;
        if (elapsed >= timeoutMs) {
          clearInterval(t);
          console.warn('Timed out waiting for qualityLevels. Will still attempt plugin init and fallback.');
          logQualityLevels();
          initHlsQualitySelectorWithGuard();
          setTimeout(addQualityFallbackIfNeeded, 300);
        }
      }, intervalMs);
    }
    
    // Function to refresh the source to handle expired URLs
    function refreshSource() {
      if (!currentVideoId) return;
      
      console.log('Refreshing video source...');
      const playlistUrl = `/api/master/${currentVideoId}?t=${Date.now()}`;
      
      // Store current playback state
      const currentTime = player.currentTime();
      const wasPaused = player.paused();
      
      // Set new source
      player.src({ src: playlistUrl, type: 'application/x-mpegURL' });
      
      // Restore playback state
      player.ready(function() {
        player.currentTime(currentTime);
        if (!wasPaused) {
          player.play().catch(e => console.warn('Autoplay prevented after refresh', e));
        }
        
        // Reinitialize quality selector
        waitAndInitQualitySelector();
      });
    }
  
    // Form submit handler
    videoForm.addEventListener('submit', async function (event) {
      event.preventDefault();
      const videoId = videoIdInput.value.trim();
      if (!videoId) { showStatus('Please enter a Video ID.', 'error'); return; }
  
      playerContentWrapper.style.display = 'none';
      player.pause();
      showStatus(`ðŸ” Validating Video ID: ${videoId}...`, 'info');
  
      try {
        const response = await fetch(`/api/status/${videoId}`);
        if (response.status === 404) throw new Error('Video not found. Please check the ID and try again.');
        if (!response.ok) throw new Error(`Server returned an error: ${response.statusText}`);
        const data = await response.json();
  
        if (data.status === 'ready') {
          statusMessage.style.display = 'none';
          playerContentWrapper.style.display = 'block';
          
          // Store current video ID for refreshing
          currentVideoId = videoId;
          
          // Clear any existing refresh interval
          if (sourceRefreshInterval) {
            clearInterval(sourceRefreshInterval);
            sourceRefreshInterval = null;
          }
          
          // Set up source refresh every 25 minutes (1500 seconds)
          // Signed URLs expire after 1800 seconds, so refresh before that
          sourceRefreshInterval = setInterval(refreshSource, 25 * 60 * 1000);
  
          // Request the signed master playlist
          const playlistUrl = `/api/master/${videoId}`;
  
          // Set the source to the signed-master playlist endpoint
          player.src({ src: playlistUrl, type: 'application/x-mpegURL' });
  
          // Wait for qualityLevels to be available and then init the plugin
          waitAndInitQualitySelector(5000, 100);
  
          // Attempt autoplay
          player.play().catch(e => console.warn('Autoplay prevented', e));
        } else if (data.status === 'processing') {
          showStatus('â³ This video is still processing. Please wait a few moments and try again.', 'warning');
        } else {
          throw new Error(`Unknown video status: "${data.status}"`);
        }
      } catch (err) {
        console.error('Failed to load video:', err);
        showStatus(`Error: ${err.message}`, 'error');
        playerContentWrapper.style.display = 'none';
      }
    });
  
    // Player error handling
    player.on('error', function() {
      const error = player.error();
      console.error('Player error:', error);
      
      // Check if error might be due to expired URLs
      if (error && error.message && (
          error.message.includes('403') || 
          error.message.includes('Forbidden') ||
          error.message.includes('Expired'))) {
        console.log('Possible expired URL detected, refreshing source...');
        refreshSource();
      } else {
        errorText.textContent = `Error: ${error ? error.message : 'Failed to load video stream'}`;
        playerErrorMessage.style.display = 'block';
      }
    });
  
    player.on('loadstart', function() {
      playerErrorMessage.style.display = 'none';
    });

    // New upload functionality
    const uploadForm = document.getElementById('upload-form');
    const videoFileInput = document.getElementById('video-file');
    const fileNameDisplay = document.getElementById('file-name');
    const uploadButton = document.getElementById('upload-button');
    const progressBar = document.getElementById('progress-bar');
    const progress = document.getElementById('progress');
    const uploadStatus = document.getElementById('upload-status');
    const sseStatus = document.getElementById('sse-status');
    const successMessage = document.getElementById('success-message');
    let eventSource = null;

    // Update file name display when a file is selected
    videoFileInput.addEventListener('change', function() {
      if (this.files.length > 0) {
        const file = this.files[0];
        fileNameDisplay.textContent = file.name;
        uploadButton.disabled = false;
      } else {
        fileNameDisplay.textContent = 'No file selected';
        uploadButton.disabled = true;
      }
    });

    // Handle upload form submission
    uploadForm.addEventListener('submit', async function(event) {
      event.preventDefault();
      
      const file = videoFileInput.files[0];
      if (!file) {
        showUploadStatus('Please select a video file.', 'error');
        return;
      }

      // Clean filename (remove spaces and ensure extension)
      const originalName = file.name;
      const extension = originalName.slice(originalName.lastIndexOf('.'));
      const cleanName = originalName.replace(/\s+/g, '') || 'video' + extension;
      
      try {
        showUploadStatus('Requesting upload URL...', 'info');
        
        // Step 1: Get presigned URL
        const response = await fetch(`/api/generate-upload-url/${cleanName}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        if (!response.ok) {
          throw new Error(`Failed to get upload URL: ${response.statusText}`);
        }
        
        const data = await response.json();
        const { presigned_url, video_id, s3_key } = data;
        
        showUploadStatus('Upload URL received. Starting upload...', 'info');
        
        // Step 2: Set up SSE connection to monitor processing status
        setupSSEConnection(video_id);
        
        // Step 3: Upload file to presigned URL
        progressBar.style.display = 'block';
        
        const xhr = new XMLHttpRequest();
        xhr.open('PUT', presigned_url, true);
        xhr.setRequestHeader('Content-Type', file.type);
        
        // Track upload progress
        xhr.upload.addEventListener('progress', function(e) {
          if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 100;
            progress.style.width = percentComplete + '%';
            showUploadStatus(`Uploading: ${Math.round(percentComplete)}% complete`, 'info');
          }
        });
        
        xhr.onload = function() {
          if (xhr.status === 200) {
            showUploadStatus('Uploaded successfully! Now video will be processed so please wait...', 'info');
            progressBar.style.display = 'none';
          } else {
            throw new Error(`Upload failed: ${xhr.statusText}`);
          }
        };
        
        xhr.onerror = function() {
          throw new Error('Upload failed due to network error');
        };
        
        xhr.send(file);
        
      } catch (error) {
        console.error('Upload error:', error);
        showUploadStatus(`Error: ${error.message}`, 'error');
        if (eventSource) eventSource.close();
      }
    });

    function showUploadStatus(message, type) {
      uploadStatus.textContent = message;
      uploadStatus.className = `status-${type}`;
      uploadStatus.style.display = 'block';
    }

    function setupSSEConnection(videoId) {
      // Close existing connection if any
      if (eventSource) {
        eventSource.close();
      }
      
      sseStatus.style.display = 'block';
      sseStatus.textContent = 'video processing will be started once video is uploaded and you will be notified once it is completed..';
      sseStatus.className = 'status-info';
      
      // Create new SSE connection
      eventSource = new EventSource(`/api/stream-status/${videoId}`);
      
      eventSource.onmessage = function(event) {
        const payload = JSON.parse(event.data);
        sseStatus.textContent = `Processing status: ${payload.data.status}`;
        
        if (payload.data.status === 'ready') {
          sseStatus.textContent = 'Processing completed successfully!';
          sseStatus.className = 'status-info';
          
          successMessage.style.display = 'block';
          successMessage.innerHTML = `
            <h3><i class="fas fa-check-circle"></i> Video Processing Complete</h3>
            <p>Your video is now ready to watch!</p>
            <p>Video ID: <span class="video-id-display">${videoId}</span></p>
            <p>Copy this ID to watch your video later.</p>
          `;
          
          eventSource.close();
        } else if (payload.data.status === 'failed') {
          sseStatus.textContent = `Processing error: ${payload.message || 'Unknown error'}`;
          sseStatus.className = 'status-error';
          eventSource.close();
        }
      };
      
      eventSource.onerror = function() {
        sseStatus.textContent = 'Connection to status server lost. Processing may still continue.';
        sseStatus.className = 'status-warning';
        eventSource.close();
      };
    }
  </script>
</body>
</html>